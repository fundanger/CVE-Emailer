import configparser
import mysql.connector

config = configparser.ConfigParser()
config.read("config.ini")
     
def create_tables(service_name):
    try:
        print("Creating table for " + str(service_name))
        connection = mysql.connector.connect( # initiate connection
            user = config['DATABASE']['username'],
            password = config['DATABASE']['password'],
            host = config['DATABASE']['host'],
            database = config['DATABASE']['database']) # DB connection
        cursor = connection.cursor()
        table_query = ("CREATE TABLE IF NOT EXISTS " + service_name +
                      """(cve_id VARCHAR(255) NOT NULL PRIMARY KEY,
                      severity_score DOUBLE(2,1),                   
                      publish_date DATE,
                      last_modified DATE,
                      description TEXT);""")
        cursor.execute(table_query)
        connection.commit()
    except mysql.connector.Error as error:
        print("An error occurred in process create_tables:" , error)
    finally:
        connection.close()
      
def insert_data(table, CVE, severity_score, publish_date, last_modified, description, email): # Connects to the DB
    try:
        connection = mysql.connector.connect( # initiate connection
            user = config['DATABASE']['username'],
            password = config['DATABASE']['password'],
            host = config['DATABASE']['host'],
            database = config['DATABASE']['database']) # DB connection
        cursor = connection.cursor()
        insert_query = "INSERT IGNORE INTO "
        + table
        + " (cve_id, severity_score, publish_date, last_modified, description)" + \
            " VALUES" + \
            " (%s, %s, %s, %s, %s);"
        value1 = CVE
        value2 = severity_score
        value3 = publish_date
        value4 = last_modified
        value5 = description
        cursor.execute(insert_query, (value1, value2, value3, value4, value5))
        connection.commit()
        if cursor.rowcount > 0:
            email += "Service: " + table
            email += "\nCVE-" + value1 + "\n"
            email += "Severity Score: " + str(value2) + "\n"
            email += "Publish Date: " + value3 + "\n"
            email += "Last Modified: " + value4 + "\n"
            email += "Description: " + value5 + "\n \n"
            
        else:
            print("No entry added.")
    except mysql.connector.Error as error:
        print("An error occurred in process insert_data:" , error)
    finally:
        connection.close()
        return str(email)