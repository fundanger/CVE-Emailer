import mysql.connector
import configparser

config = configparser.ConfigParser()
config.read("config.ini")

def connectDB(username, password, host, database): # Connects to the DB
    connection = None
    try:
        connection = mysql.connector.connect( # initiate connection
            user = username, 
            password = password, 
            host = host, 
            database = database) # DB connection
        connection.cursor()
        print("Connected to Database!")
    except mysql.connector.Error as error:
        print("Failed to connect to MySQL database:" , error)
    finally:
        print("Connection Closing")
        connection.close()

def compareDB(serviceName): # TO DO: Compares entries in the database to know if an email needs to be sent
    try:
        connection = mysql.connector.connect( # initiate connection
            config['DATABASE']['username'],
            config['DATABASE']['password'],
            config['DATABASE']['host'],
            config['DATABASE']['database'],) # DB connection
        connection.cursor()
        print("Connected to Database!")
    except mysql.connector.Error as error:
        print("Failed to connect to MySQL database:" , error)
    finally:
        print("connection closing")
        connection.close()
        
def createTables(service_name):
    try:
        print("Creating table for " + str(service_name))
        connection = mysql.connector.connect( # initiate connection
            user = config['DATABASE']['username'],
            password = config['DATABASE']['password'],
            host = config['DATABASE']['host'],
            database = config['DATABASE']['database']) # DB connection
        cursor = connection.cursor()
        print("Connected to Database!")
        tableQuery = ("CREATE TABLE IF NOT EXISTS " + service_name +
                      """(cve_id VARCHAR(255) NOT NULL PRIMARY KEY,                   
                      publish_date DATE,
                      last_modified DATE,
                      description TEXT);""")
        cursor.execute(tableQuery)
        connection.commit()
    except mysql.connector.Error as error:
        print("Failed to connect to MySQL database:" , error)
    finally:
        print("Connection Closing")
        connection.close()
    
    
def insertData(table, CVE, publish_date, last_modified, description): # Connects to the DB
    try:
        connection = mysql.connector.connect( # initiate connection
            user = config['DATABASE']['username'],
            password = config['DATABASE']['password'],
            host = config['DATABASE']['host'],
            database = config['DATABASE']['database']) # DB connection
        cursor = connection.cursor()
        insertQuery = "INSERT IGNORE INTO " + table + " (cve_id, publish_date, last_modified, description)" + \
            " VALUES" + \
            " (%s, %s, %s, %s);"
        value1 = CVE
        value2 = publish_date
        value3 = last_modified
        value4 = description
        cursor.execute(insertQuery, (value1, value2, value3, value4))
        connection.commit()
        print("Insert query executed")
        print("Connected to Database!")
    except mysql.connector.Error as error:
        print("Failed to connect to MySQL database:" , error)
    finally:
        print("Connection Closing")
        connection.close()
    
    
